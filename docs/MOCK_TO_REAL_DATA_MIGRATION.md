# モックデータから本物データへの移行ガイド

## 概要
現在のアプリケーションでは以下の箇所でモックデータが使用されています。本文書では、これらをすべて本物のデータに置き換える方法を説明します。

## 現在のモックデータ使用箇所

### 1. data/fetcher.py - KyoteiDataFetcher クラス
**ファイル**: `data/fetcher.py`

#### モック関数
- `_get_sample_races()` (617-638行): サンプルレース一覧生成
- `_get_sample_races_tomorrow()` (172-206行): 明日のサンプルレース生成  
- `_get_sample_race_detail()` (640-643行): サンプルレース詳細生成

#### 使用されている箇所
- エラー発生時のフォールバック (401, 411, 421, 441, 443行)
- レーサー情報解析失敗時の補完 (434, 454, 457行)

### 2. data/models.py - create_sample_race 関数
**ファイル**: `data/models.py`

#### モック関数
- `create_sample_race()` (214行以降): 完全なサンプルレースデータ生成

#### 特徴
- 6人のダミーレーサーデータ
- ランダムな成績データ
- 固定的なレーン情報、天候、水面状況

### 3. kyotei.py - テスト機能
**ファイル**: `kyotei.py`

#### モック使用箇所  
- `test` コマンドでサンプルレース使用 (221-240行)

## 実データ取得システム

### 既存の実装
**ファイル**: `data/real_fetcher.py`
- `RealBoatraceDataFetcher` クラスが実装済み
- 競艇公式サイト (boatrace.jp) からデータ取得
- レート制限、リトライ機能搭載

### 機能
- 本日・明日のレース一覧取得
- レース詳細情報取得  
- レーサー統計情報取得
- キャッシュ機能搭載

## 移行計画

### フェーズ1: 設定による切り替え機能実装
**目標**: モック/実データを設定で切り替え可能にする

1. **設定項目追加**
   ```python
   # config/settings.py
   "DATA_MODE": {
       "use_real_data": False,  # True: 実データ, False: モックデータ
       "fallback_to_mock": True  # 実データ取得失敗時にモックを使用
   }
   ```

2. **ファクトリーパターン実装**
   ```python
   # data/factory.py
   def create_data_fetcher():
       if get_setting("DATA_MODE")["use_real_data"]:
           return RealBoatraceDataFetcher()
       else:
           return KyoteiDataFetcher()
   ```

3. **CLI設定メニュー追加**
   - データモード切り替えオプション追加
   - 現在のモード表示機能追加

### フェーズ2: 段階的実データ移行  
**目標**: 機能ごとに段階的に実データに移行

1. **今日のレース一覧**: 最もシンプルな実装
2. **明日のレース一覧**: 日付処理の検証
3. **レース詳細情報**: 複雑なパース処理の検証
4. **レーサー統計**: 最も複雑なデータ構造

### フェーズ3: エラーハンドリング強化
**目標**: 実データ取得失敗時の適切な処理

1. **階層的フォールバック**
   - 実データ → キャッシュデータ → モックデータ
   
2. **部分データ補完**
   - 実データの一部が欠損している場合の補完

3. **ユーザー通知**
   - データソース表示
   - 取得失敗時の警告表示

### フェーズ4: モックデータ削除
**目標**: 完全に実データ化

1. **モック関数削除**
   - `_get_sample_races()`
   - `_get_sample_race_detail()` 
   - `create_sample_race()`

2. **テストデータ分離**
   - テスト用サンプルデータを別モジュールに移動
   - 本番コードからモック依存を完全削除

## 実装上の注意点

### 1. データ構造の互換性
- 実データとモックデータの構造を完全一致させる
- 新しいフィールドが追加される可能性を考慮

### 2. パフォーマンス
- キャッシュ機能の積極的活用
- 不要なリクエストの削減
- レート制限の遵守

### 3. エラーハンドリング
- ネットワークエラー
- パース失敗  
- データ不整合
- API制限

### 4. ログ出力
- データ取得状況の詳細ログ
- エラー時の詳細情報記録
- パフォーマンス監視

## 段階的移行手順

### ステップ1: 設定機能実装 (推定時間: 2-3時間)
1. 設定項目追加
2. ファクトリー実装
3. CLI設定メニュー更新

### ステップ2: 基本データ移行 (推定時間: 4-5時間)
1. レース一覧の実データ化
2. エラーハンドリング実装
3. テスト実行・検証

### ステップ3: 詳細データ移行 (推定時間: 6-8時間)  
1. レース詳細の実データ化
2. レーサー統計の実データ化
3. データ整合性検証

### ステップ4: クリーンアップ (推定時間: 1-2時間)
1. モック関数削除
2. テストデータ分離
3. ドキュメント更新

## 検証方法

### 1. 機能テスト
- 全機能が実データで動作することを確認
- エラー時のフォールバック動作確認

### 2. パフォーマンステスト  
- レスポンス時間測定
- キャッシュ効果確認
- メモリ使用量監視

### 3. ユーザビリティテスト
- 設定変更の使いやすさ確認
- エラーメッセージの分かりやすさ確認

## リスク管理

### 高リスク
- 実データ構造の変更 → 継続的な監視が必要
- API制限によるアクセス拒否 → レート制限の厳格な遵守

### 中リスク  
- ネットワーク不安定 → リトライ機能とタイムアウト設定
- データ不整合 → バリデーション強化

### 低リスク
- パフォーマンス低下 → キャッシュ最適化で対応可能

## まとめ
本移行により、アプリケーションは完全に実データベースで動作し、より実用的な競艇予想システムとなります。段階的な移行により、各段階でのリスクを最小限に抑えながら安全に実装できます。