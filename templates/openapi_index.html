<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>競艇予想システム - 今日のレース</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #333;
            --header-color: #007bff;
            --border-color: #e0e0e0;
            --shadow: rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #ffffff;
            --header-color: #4dabf7;
            --border-color: #404040;
            --shadow: rgba(0,0,0,0.3);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow);
            padding: 30px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--header-color);
            position: relative;
        }
        .header h1 {
            color: var(--header-color);
            margin: 0;
            font-size: 2.2em;
        }
        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--header-color);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover {
            transform: scale(1.05);
            opacity: 0.8;
        }
        .header p {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        .race-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .race-card {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            background-color: var(--container-bg);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .race-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 15px rgba(0,123,255,0.2);
            transform: translateY(-2px);
        }
        .race-card.finished {
            opacity: 0.5;
            background-color: #f8f9fa;
            border-color: #d6d8db;
            cursor: not-allowed;
        }
        [data-theme="dark"] .race-card.finished {
            background-color: #3a3a3a;
            border-color: #555;
            color: #888;
        }
        .race-card.finished:hover {
            border-color: #d6d8db;
            box-shadow: none;
            transform: none;
        }
        .race-card.finished .race-venue {
            color: #6c757d;
        }
        .race-card.finished .race-number {
            background-color: #e9ecef;
            border-color: #adb5bd;
            color: #6c757d;
        }
        .race-card.finished .race-time {
            color: #adb5bd;
        }
        .finished-label {
            display: inline-block;
            background-color: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 8px;
        }
        .prediction-section {
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        .prediction-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .prediction-label {
            color: #666;
            font-weight: bold;
            flex: 0 0 auto;
        }
        .prediction-value {
            color: var(--header-color);
            font-weight: bold;
            text-align: right;
        }
        .result-row {
            background-color: #f8f9fa;
            border-left: 4px solid #28a745;
            padding-left: 8px;
        }
        .result-value {
            color: #28a745;
            font-weight: bold;
            text-align: right;
        }
        .hit-status .hit {
            color: #28a745;
            font-weight: bold;
        }
        .hit-status .miss {
            color: #dc3545;
            font-weight: bold;
        }
        .confidence-stars {
            color: #ffc107;
            font-size: 0.8em;
        }
        .hit-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75em;
            margin-left: 5px;
        }
        .hit-indicator.hit {
            background-color: #28a745;
            color: white;
        }
        .hit-indicator.miss {
            background-color: #dc3545;
            color: white;
        }
        .vs-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .vs-arrow {
            color: #666;
            font-size: 0.8em;
        }
        .race-venue {
            font-size: 1.3em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 8px;
        }
        .race-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .race-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #dc3545;
            background-color: #fff5f5;
            padding: 5px 12px;
            border-radius: 20px;
            border: 2px solid #dc3545;
        }
        .race-time {
            font-size: 1.1em;
            color: #28a745;
            font-weight: bold;
        }
        .confidence-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }
        .confidence-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }
        .confidence-value {
            font-size: 1.1em;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .confidence-high {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .confidence-medium {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .confidence-low {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .race-title {
            color: #666;
            font-size: 0.9em;
            margin-top: 8px;
            font-style: italic;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            text-align: center;
            font-size: 1.1em;
        }
        .loading {
            text-align: center;
            color: #666;
            font-size: 1.2em;
            padding: 40px;
        }
        /* ロードインジケーター用CSS */
        .loading-section {
            text-align: center;
            padding: 40px;
            background-color: var(--container-bg);
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 4px solid var(--border-color);
            border-left: 4px solid var(--header-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text h3 {
            color: var(--header-color);
            margin-bottom: 20px;
        }
        
        #progress-bar {
            width: 100%;
            max-width: 400px;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            margin: 20px auto;
            overflow: hidden;
        }
        
        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--header-color), #4dabf7);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        #loading-message {
            color: var(--text-color);
            font-size: 1.1em;
            margin: 10px 0;
        }
        
        #loading-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        #loading-step {
            font-weight: bold;
            color: var(--header-color);
        }
        
        .race-card.loading-placeholder {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            .race-grid {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 1.8em;
            }
            .prediction-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                margin-bottom: 10px;
            }
            .prediction-value,
            .result-value {
                text-align: left;
            }
            .vs-display {
                flex-wrap: wrap;
            }
            .loading-section {
                padding: 30px 20px;
            }
            #progress-bar {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()">🌙 ダーク</button>
            <h1>🏁 競艇予想システム</h1>
            <p>{{ current_time }} 現在のレース情報</p>
            <div style="margin-top: 15px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; align-items: center;">
                <a href="/accuracy" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 10px 20px; text-decoration: none; border-radius: 20px; font-weight: bold;">📊 的中率レポート</a>
                <a href="/dashboard" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 20px; text-decoration: none; border-radius: 20px; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">🚀 AI統合ダッシュボード</a>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label for="date-select" style="color: #666; font-size: 0.9em;">📅 日付:</label>
                    <input type="date" id="date-select" value="{% if selected_date %}{{ selected_date }}{% else %}{{ today_date }}{% endif %}" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 0.9em;" onchange="changeDate(this.value)">
                </div>
            </div>
        </div>

        {% if error %}
        <div class="error-message">
            ❌ {{ error }}
        </div>
        {% else %}
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number">{{ total_races }}</div>
                <div class="stat-label">本日開催レース数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ races|selectattr('start_time', 'ne', '未定')|list|length }}</div>
                <div class="stat-label">発走時刻確定</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ races|map(attribute='venue_name')|unique|list|length }}</div>
                <div class="stat-label">開催場数</div>
            </div>
            <div class="stat-item">
                <button onclick="forceClearCache()" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 8px 16px; border: none; border-radius: 15px; font-size: 0.8em; cursor: pointer; font-weight: bold;" title="古いキャッシュデータを強制削除">🗑️ キャッシュクリア</button>
            </div>
        </div>

        <!-- ロードインジケーター -->
        <div id="loading-indicator" class="loading-section">
            <div class="loading-spinner"></div>
            <div class="loading-text">
                <h3 id="loading-title">📊 レースデータを読み込み中...</h3>
                <div id="progress-bar">
                    <div id="progress-fill"></div>
                </div>
                <p id="loading-message">データ取得を開始しています...</p>
                <div id="loading-details">
                    <span id="loading-step">準備中</span> - 
                    <span id="loading-progress">0</span>/<span id="loading-total">5</span>
                </div>
            </div>
        </div>

        <!-- レース一覧（動的に追加） -->
        <div id="race-grid" class="race-grid" style="display: none;">
            <!-- JavaScriptで動的に追加 -->
        </div>

        <!-- エラー表示 -->
        <div id="error-section" class="error-message" style="display: none;">
            <span id="error-text"></span>
        </div>
        {% endif %}
    </div>

    <script>
        // テーマ切り替え機能
        function toggleTheme() {
            const body = document.body;
            const button = document.querySelector('.theme-toggle');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                button.textContent = '🌙 ダーク';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                button.textContent = '☀️ ライト';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // ページ読み込み時にテーマを復元
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const button = document.querySelector('.theme-toggle');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                button.textContent = '☀️ ライト';
            }
            
            // 古いキャッシュデータの自動クリア（当日以外のデータは削除）
            checkAndClearOldCache();
            
            // キャッシュを強制クリアして新規データロード
            sessionStorage.removeItem(RACE_DATA_CACHE_KEY);
            sessionStorage.removeItem(CACHE_EXPIRY_KEY);
            console.log('キャッシュを強制クリアしました');
            
            // 予測データ込みの統合APIを使用したデータロード
            loadRaceDataFromFullAPI();
        });
        
        // ブラウザの戻るボタンでページに戻った場合もキャッシュを活用
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                // ページが bfcache から復元された場合
                console.log('ページがキャッシュから復元されました');
                const cachedData = getCachedRaceData();
                if (cachedData) {
                    displayRaceData(cachedData);
                }
            }
        });

        // セッションストレージキャッシュキー
        const RACE_DATA_CACHE_KEY = 'race_data_cache';
        const CACHE_EXPIRY_KEY = 'race_data_cache_expiry';
        const CACHE_DURATION = 5 * 60 * 1000; // 5分間キャッシュ

        // キャッシュから取得
        function getCachedRaceData() {
            try {
                const cachedData = sessionStorage.getItem(RACE_DATA_CACHE_KEY);
                const cacheExpiry = sessionStorage.getItem(CACHE_EXPIRY_KEY);
                
                if (cachedData && cacheExpiry) {
                    const expiry = parseInt(cacheExpiry);
                    if (Date.now() < expiry) {
                        console.log('キャッシュからレースデータを取得');
                        return JSON.parse(cachedData);
                    }
                }
                return null;
            } catch (error) {
                console.warn('キャッシュ取得エラー:', error);
                return null;
            }
        }

        // キャッシュに保存
        function setCachedRaceData(data) {
            try {
                sessionStorage.setItem(RACE_DATA_CACHE_KEY, JSON.stringify(data));
                sessionStorage.setItem(CACHE_EXPIRY_KEY, (Date.now() + CACHE_DURATION).toString());
                console.log('レースデータをキャッシュに保存');
            } catch (error) {
                console.warn('キャッシュ保存エラー:', error);
            }
        }
        
        // 古いキャッシュデータの自動チェック・クリア機能
        function checkAndClearOldCache() {
            try {
                const cachedData = sessionStorage.getItem(RACE_DATA_CACHE_KEY);
                if (cachedData) {
                    const data = JSON.parse(cachedData);
                    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                    
                    // キャッシュされたデータの中に明らかに古い（今日以外の）レースが含まれているかチェック
                    if (data.races && data.races.length > 0) {
                        const hasOldRaces = data.races.some(race => {
                            if (race.start_time && race.start_time !== '未定') {
                                const raceDate = race.start_time.split(' ')[0];
                                return raceDate !== today;
                            }
                            return false;
                        });
                        
                        if (hasOldRaces) {
                            console.log('古いレースデータを検出、キャッシュを自動クリア');
                            sessionStorage.removeItem(RACE_DATA_CACHE_KEY);
                            sessionStorage.removeItem(CACHE_EXPIRY_KEY);
                        }
                    }
                }
            } catch (error) {
                console.warn('古いキャッシュチェックエラー:', error);
                // エラー時は安全のためキャッシュをクリア
                sessionStorage.removeItem(RACE_DATA_CACHE_KEY);
                sessionStorage.removeItem(CACHE_EXPIRY_KEY);
            }
        }
        
        // キャッシュ強制クリア機能
        function forceClearCache() {
            try {
                sessionStorage.removeItem(RACE_DATA_CACHE_KEY);
                sessionStorage.removeItem(CACHE_EXPIRY_KEY);
                console.log('キャッシュを強制クリアしました');
                
                // サーバー側キャッシュもクリア
                fetch('/api/races/clear-cache')
                    .then(response => response.json())
                    .then(data => {
                        console.log('サーバーキャッシュクリア:', data.message);
                        // ページをリロードして最新データを取得
                        location.reload();
                    })
                    .catch(error => {
                        console.warn('サーバーキャッシュクリアエラー:', error);
                        // ページをリロードして最新データを取得
                        location.reload();
                    });
                    
            } catch (error) {
                console.warn('キャッシュクリアエラー:', error);
                location.reload();
            }
        }

        // キャッシュされたデータを表示
        async function displayRaceData(cachedData) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const raceGrid = document.getElementById('race-grid');
            const stats = document.querySelector('.stats');
            
            // キャッシュからのデータ表示は即座に行う
            loadingIndicator.style.display = 'none';
            raceGrid.style.display = 'grid';
            
            // レースデータ表示
            displayRaces(cachedData.races);
            
            // 統計情報更新
            updateStats(cachedData.races);
            
            // キャッシュされたデータに予想情報があるか確認して表示
            displayCachedPredictions(cachedData.races);
            
            // ホバー効果設定
            setupHoverEffects();
            
            console.log(`キャッシュから${cachedData.races.length}件のレースを表示しました`);
        }

        // キャッシュチェック付きデータ読み込み（改善版）
        async function loadRaceDataWithCacheCheck() {
            const cachedData = getCachedRaceData();
            
            if (cachedData && cachedData.races && cachedData.races.length > 0) {
                // 有効なキャッシュがある場合：即座に表示してから背景で更新
                console.log('キャッシュからデータを表示し、背景で更新します');
                displayRaceData(cachedData);
                
                // 予想データが不完全な場合や古い場合は背景で更新
                const now = Date.now();
                const cacheAge = now - cachedData.timestamp;
                const hasMissingPredictions = cachedData.races.some(race => !race.prediction);
                
                if (cacheAge > 60000 || hasMissingPredictions) { // 1分以上経過または予想データ不足
                    console.log('背景で予想データを更新します');
                    try {
                        await loadPredictions(cachedData.races);
                    } catch (error) {
                        console.warn('背景更新失敗:', error);
                    }
                }
            } else {
                // キャッシュがないか空の場合：フル読み込み
                if (cachedData && cachedData.races && cachedData.races.length === 0) {
                    console.log('空のキャッシュを検出、キャッシュクリアして新規データ読み込み');
                    sessionStorage.removeItem(RACE_DATA_CACHE_KEY);
                    sessionStorage.removeItem(CACHE_EXPIRY_KEY);
                } else {
                    console.log('キャッシュなし、新規データ読み込み');
                }
                await loadRaceData();
            }
        }

        // 非同期レースデータ読み込み機能
        async function loadRaceData() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const raceGrid = document.getElementById('race-grid');
            const errorSection = document.getElementById('error-section');
            const stats = document.querySelector('.stats');
            
            try {
                // デバッグ: API呼び出し開始
                console.log('新規APIデータ取得を開始します');

                // Step 1: 基本データ取得
                updateLoadingProgress('データ取得', 1, 4, 'レースデータを取得中...');
                
                // 選択された日付を取得
                const selectedDate = getSelectedDate();
                const url = selectedDate ? `/api/races/basic?date=${selectedDate}` : '/api/races/basic';
                
                console.log('API呼び出しURL:', url);
                const response = await fetch(url);
                console.log('API応答ステータス:', response.status);
                const data = await response.json();
                console.log('API取得データ:', data);
                
                // デバッグログ追加
                console.log('[DEBUG] API response:', data);
                console.log('[DEBUG] data.success:', data.success);
                console.log('[DEBUG] data.races type:', typeof data.races);
                console.log('[DEBUG] data.races length:', data.races ? data.races.length : 'undefined');
                console.log('[DEBUG] First race sample:', data.races ? data.races[0] : 'no races');
                
                if (!data.success) {
                    throw new Error(data.error || 'データ取得に失敗しました');
                }
                
                // Step 2: 基本レース情報表示
                updateLoadingProgress('表示準備', 2, 4, 'レース情報を準備中...');
                await new Promise(resolve => setTimeout(resolve, 500)); // UX向上のための少しの待機
                
                const races = data.races;
                console.log('[DEBUG] About to call displayRaces with:', races);
                displayRaces(races);
                
                // 統計情報更新
                updateStats(races);
                
                // Step 3: AI予想データ取得
                updateLoadingProgress('AI予想計算', 3, 4, 'AI予想を計算中...');
                await loadPredictions(races);
                
                // Step 4: 完了とキャッシュ保存
                updateLoadingProgress('完了', 4, 4, `${races.length}件のレースを取得完了`);
                
                // データをキャッシュに保存
                setCachedRaceData({
                    races: races,
                    timestamp: Date.now(),
                    stats: {
                        total: races.length,
                        finished: races.filter(r => r.is_finished).length
                    }
                });
                
                // ローディングを隠してレースグリッドを表示
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                    raceGrid.style.display = 'grid';
                    
                    // ホバー効果を再設定
                    setupHoverEffects();
                }, 1000);
                
            } catch (error) {
                console.error('データ読み込みエラー:', error);
                showError(error.message);
            }
        }

        // 予測データ込み統合API使用のデータ読み込み
        async function loadRaceDataFromFullAPI() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const raceGrid = document.getElementById('race-grid');
            const errorSection = document.getElementById('error-section');
            
            try {
                // ローディング表示
                loadingIndicator.style.display = 'block';
                raceGrid.style.display = 'none';
                errorSection.style.display = 'none';
                
                updateLoadingProgress('統合データ取得', 1, 2, '予測データ込みレース情報を取得中...');
                console.log('予測データ込み統合APIを呼び出します: /api/races');
                
                // 統合APIを呼び出し（予測データも含む）
                const response = await fetch('/api/races');
                const data = await response.json();
                
                console.log('[DEBUG] Full API response:', data);
                console.log('[DEBUG] Total races:', data.races ? data.races.length : 0);
                console.log('[DEBUG] Sample race:', data.races && data.races[0]);
                
                if (!data.success || !data.races) {
                    throw new Error(data.error || 'レースデータの取得に失敗しました');
                }
                
                updateLoadingProgress('表示準備', 2, 2, 'レース表示を準備中...');
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // レースデータを表示
                displayRaces(data.races);
                
                // 統計情報更新
                updateStats(data.races);
                
                // キャッシュに保存
                setCachedRaceData({
                    races: data.races,
                    timestamp: Date.now(),
                    stats: {
                        total: data.races.length,
                        finished: data.races.filter(r => r.is_finished).length
                    }
                });
                
                // 完了
                loadingIndicator.style.display = 'none';
                raceGrid.style.display = 'grid';
                
                console.log(`統合APIから${data.races.length}件のレースを表示（予測データ含む）`);
                
            } catch (error) {
                console.error('統合API読み込みエラー:', error);
                showError(`レースデータの読み込みに失敗しました: ${error.message}`);
            }
        }

        // 進捗更新
        function updateLoadingProgress(step, progress, total, message) {
            const progressPercent = (progress / total) * 100;
            
            document.getElementById('loading-step').textContent = step;
            document.getElementById('loading-progress').textContent = progress;
            document.getElementById('loading-total').textContent = total;
            document.getElementById('loading-message').textContent = message;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
        }

        // レース表示
        function displayRaces(races) {
            console.log('[DEBUG] displayRaces called with:', races);
            console.log('[DEBUG] races is Array?', Array.isArray(races));
            console.log('[DEBUG] races length:', races ? races.length : 'races is null/undefined');
            
            const raceGrid = document.getElementById('race-grid');
            raceGrid.innerHTML = '';
            
            if (!races || !Array.isArray(races)) {
                console.error('[ERROR] races is not an array:', races);
                raceGrid.innerHTML = '<div class="error-message">レースデータの形式が正しくありません</div>';
                return;
            }
            
            races.forEach((race, index) => {
                console.log(`[DEBUG] Processing race ${index}:`, race);
                const raceCard = createRaceCard(race);
                raceGrid.appendChild(raceCard);
            });
        }

        // 信頼度分類関数
        function getConfidenceClass(confidence) {
            if (confidence >= 70) return 'confidence-high';
            if (confidence >= 55) return 'confidence-medium';
            return 'confidence-low';
        }

        // レースカード作成
        function createRaceCard(race) {
            console.log('[DEBUG] createRaceCard called with race:', race);
            console.log('[DEBUG] race.venue_name:', race.venue_name);
            console.log('[DEBUG] race.race_number:', race.race_number);
            console.log('[DEBUG] race.start_time:', race.start_time);
            console.log('[DEBUG] race.race_title:', race.race_title);
            console.log('[DEBUG] race.race_id:', race.race_id);
            
            const div = document.createElement('div');
            div.className = `race-card ${race.is_finished ? 'finished' : ''}`;
            div.onclick = () => {
                if (!race.is_finished) {
                    location.href = `/predict/${race.race_id}`;
                }
            };
            
            // 信頼度パーセンテージ計算（修正版）
            let confidencePercent = 50; // デフォルト値
            
            if (race.prediction && race.prediction.confidence !== undefined) {
                // prediction.confidence の値を使用（0.5 -> 50%変換）
                confidencePercent = Math.round(race.prediction.confidence * 100);
            } else if (race.unified_confidence) {
                // unified_confidence がある場合（0-1範囲で100倍）
                confidencePercent = Math.round(race.unified_confidence * 100);
            } else if (race.confidence && race.confidence > 1) {
                // confidence が既にパーセンテージの場合
                confidencePercent = Math.round(race.confidence);
            } else if (race.confidence) {
                // confidence が0-1範囲の場合（100倍）
                confidencePercent = Math.round(race.confidence * 100);
            }
            
            // 予測・結果データの表示状態を決定
            const hasPredictionOrResult = race.prediction || race.result;
            const predictionDisplay = hasPredictionOrResult ? 'block' : 'none';
            
            div.innerHTML = `
                <div class="race-venue">
                    ${race.venue_name}
                    ${race.is_finished ? '<span class="finished-label">終了</span>' : ''}
                </div>
                <div class="race-info">
                    <div class="race-number">${race.race_number}R</div>
                    <div class="race-time">${race.start_time}</div>
                </div>
                <div class="confidence-display">
                    <span class="confidence-label">信頼度:</span>
                    <span class="confidence-value ${getConfidenceClass(confidencePercent)}">${confidencePercent}%</span>
                </div>
                ${race.race_title ? `<div class="race-title">${race.race_title}</div>` : ''}
                <div id="prediction-${race.race_id}" class="prediction-section" style="display: ${predictionDisplay};">
                    <!-- 予想データは後で追加 -->
                </div>
            `;
            
            // 予測・結果データがある場合は即座に表示
            if (hasPredictionOrResult) {
                setTimeout(() => {
                    displayPredictionForRace(race.race_id, race.prediction, race.result);
                }, 0);
            }
            
            return div;
        }

        // キャッシュされた予想データを表示（改善版）
        function displayCachedPredictions(races) {
            races.forEach(race => {
                if (race.prediction || race.result) {
                    displayPredictionForRace(race.race_id, race.prediction, race.result);
                }
            });
        }
        
        // 個別レースの予想データを表示（改善版）
        function displayPredictionForRace(raceId, prediction, result = null) {
            const predictionSection = document.getElementById(`prediction-${raceId}`);
            if (!predictionSection || (!prediction && !result)) return;
            
            let html = '';
            
            // 結果データが存在する場合は結果を優先表示
            if (result && result.winning_boat) {
                const placeResults = result.place_results || [];
                html += `
                    <div class="prediction-row result-row">
                        <span>🏁 結果:</span>
                        <span class="result-value">1位: ${result.winning_boat}号艇</span>
                    </div>
                `;
                
                if (placeResults.length >= 3) {
                    html += `
                        <div class="prediction-row result-row">
                            <span>📊 着順:</span>
                            <span class="result-value">${placeResults[0]}-${placeResults[1]}-${placeResults[2]}</span>
                        </div>
                    `;
                }
                
                // 予想が的中したかチェック
                if (prediction && prediction.predicted_win) {
                    const isHit = prediction.predicted_win === result.winning_boat;
                    const hitStatus = isHit ? '✅ 的中!' : '❌ 外れ';
                    html += `
                        <div class="prediction-row hit-status">
                            <span>🎯 単勝:</span>
                            <span class="hit-status ${isHit ? 'hit' : 'miss'}">${hitStatus}</span>
                        </div>
                    `;
                }
            }
            
            // 予想データの表示
            if (prediction && prediction.predicted_win) {
                html += `
                    <div class="prediction-row">
                        <span>🏆 単勝推奨:</span>
                        <span class="prediction-value">${prediction.predicted_win}号艇</span>
                    </div>
                `;
            }
            
            if (prediction && prediction.predicted_place && prediction.predicted_place.length > 0) {
                html += `
                    <div class="prediction-row">
                        <span>🎯 複勝推奨:</span>
                        <span class="prediction-value">${prediction.predicted_place.join('-')}号艇</span>
                    </div>
                `;
            }
            
            if (prediction && prediction.confidence) {
                const confidencePercent = Math.round(prediction.confidence * 100);
                const stars = generateConfidenceStars(prediction.confidence);
                html += `
                    <div class="prediction-row">
                        <span>⭐ 予想精度:</span>
                        <span class="prediction-confidence">${stars} ${confidencePercent}%</span>
                    </div>
                `;
            }
            
            if (html) {
                predictionSection.innerHTML = html;
                predictionSection.style.display = 'block';
            }
        }

        // AI予想データ取得（改善版）
        async function loadPredictions(races) {
            try {
                const response = await fetch('/api/races');
                const data = await response.json();
                
                if (data.success && data.races) {
                    // 既存の予想データを保持しつつ、新しいデータで更新
                    const raceMap = new Map();
                    races.forEach(race => raceMap.set(race.race_id, race));
                    
                    data.races.forEach(fullRace => {
                        if (fullRace.prediction) {
                            // レースデータに予想データを追加
                            const existingRace = raceMap.get(fullRace.race_id);
                            if (existingRace) {
                                existingRace.prediction = fullRace.prediction;
                            }
                            updateRacePrediction(fullRace);
                        }
                    });
                    
                    // 更新されたレースデータをキャッシュに再保存
                    setCachedRaceData({
                        races: Array.from(raceMap.values()),
                        timestamp: Date.now(),
                        stats: {
                            total: races.length,
                            finished: races.filter(r => r.is_finished).length
                        }
                    });
                }
            } catch (error) {
                console.warn('予想データ取得失敗:', error);
                // 既存のキャッシュされた予想データがあれば表示
                displayCachedPredictions(races);
            }
        }

        // レース予想更新
        function updateRacePrediction(race) {
            const predictionSection = document.getElementById(`prediction-${race.race_id}`);
            if (!predictionSection || !race.prediction) return;
            
            const prediction = race.prediction;
            const result = race.result;
            
            let html = '';
            
            // 予想データ
            if (prediction && prediction.predicted_win) {
                html += `
                    <div class="prediction-row">
                        <span>🏆 単勝推奨:</span>
                        <span class="prediction-value">${prediction.predicted_win}号艇</span>
                    </div>
                `;
            }
            
            if (prediction && prediction.predicted_place && prediction.predicted_place.length > 0) {
                html += `
                    <div class="prediction-row">
                        <span>🎯 複勝推奨:</span>
                        <span class="prediction-value">${prediction.predicted_place.join('-')}号艇</span>
                    </div>
                `;
            }
            
            if (prediction && prediction.confidence) {
                const confidencePercent = Math.round(prediction.confidence * 100);
                const stars = generateConfidenceStars(prediction.confidence);
                html += `
                    <div class="prediction-row">
                        <span>⭐ 予想精度:</span>
                        <span class="prediction-confidence">${stars} ${confidencePercent}%</span>
                    </div>
                `;
            }
            
            // 結果データ
            if (result) {
                html += `
                    <div class="prediction-row">
                        <span class="prediction-label">実際:</span>
                        <div class="vs-display">
                            ${prediction ? `<span class="prediction-value">${prediction.predicted_win}号艇</span><span class="vs-arrow">→</span>` : ''}
                            <span class="result-value">
                                ${result.winning_boat}号艇
                                ${prediction ? `<span class="hit-indicator ${prediction.predicted_win == result.winning_boat ? 'hit' : 'miss'}">${prediction.predicted_win == result.winning_boat ? '✓' : '✗'}</span>` : ''}
                            </span>
                        </div>
                    </div>
                `;
                
                if (result.place_results && result.place_results.length > 0) {
                    html += `
                        <div class="prediction-row">
                            <span class="prediction-label">着順:</span>
                            <span class="result-value">
                                ${result.place_results.slice(0, 3).join('-')}号艇
                            </span>
                        </div>
                    `;
                }
            }
            
            if (html) {
                predictionSection.innerHTML = html;
                predictionSection.style.display = 'block';
            }
        }

        // 信頼度星生成
        function generateConfidenceStars(confidence) {
            const totalStars = 5;
            const filledStars = Math.floor((confidence || 0.5) * totalStars);
            const emptyStars = totalStars - filledStars;
            
            return '★'.repeat(filledStars) + '☆'.repeat(emptyStars);
        }

        // 統計情報更新
        function updateStats(races) {
            const totalRaces = races.length;
            const confirmedTimes = races.filter(race => race.start_time !== '未定').length;
            const venues = new Set(races.map(race => race.venue_name)).size;
            
            document.querySelector('.stats').innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${totalRaces}</div>
                    <div class="stat-label">本日開催レース数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${confirmedTimes}</div>
                    <div class="stat-label">発走時刻確定</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${venues}</div>
                    <div class="stat-label">開催場数</div>
                </div>
            `;
        }

        // エラー表示
        function showError(message) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorSection = document.getElementById('error-section');
            const errorText = document.getElementById('error-text');
            
            loadingIndicator.style.display = 'none';
            errorText.textContent = `❌ ${message}`;
            errorSection.style.display = 'block';
        }

        // ホバー効果設定
        function setupHoverEffects() {
            document.querySelectorAll('.race-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    const isDark = document.body.getAttribute('data-theme') === 'dark';
                    this.style.background = isDark ? 
                        'linear-gradient(135deg, #3d3d3d 0%, #4a4a4a 100%)' :
                        'linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.background = '';
                });
            });
        }

        // 日付選択機能
        function getSelectedDate() {
            const dateInput = document.getElementById('date-select');
            // タイムゾーンを考慮した今日の日付を取得
            const now = new Date();
            const today = now.getFullYear() + '-' + 
                         String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(now.getDate()).padStart(2, '0');
            const selectedValue = dateInput ? dateInput.value : null;
            
            console.log('今日の日付 (修正版):', today);
            console.log('選択された日付:', selectedValue);
            console.log('パラメータ使用判定:', selectedValue !== today);
            
            // 今日の日付の場合はnull、過去の日付の場合はその値を返す
            return selectedValue && selectedValue !== today ? selectedValue : null;
        }
        
        function changeDate(selectedDate) {
            // タイムゾーンを考慮した今日の日付を取得
            const now = new Date();
            const today = now.getFullYear() + '-' + 
                         String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(now.getDate()).padStart(2, '0');
            if (selectedDate === today) {
                // 今日の日付が選択された場合、パラメータなしでリロード
                window.location.href = '/';
            } else {
                // 過去の日付が選択された場合、日付パラメータ付きでリロード
                window.location.href = `/?date=${selectedDate}`;
            }
        }

        // 自動リロード（5分間隔）
        setTimeout(function() {
            location.reload();
        }, 300000);
    </script>
</body>
</html>