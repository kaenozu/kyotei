<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoatraceOpenAPI - ‰ªäÊó•„ÅÆ„É¨„Éº„Çπ</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #333;
            --header-color: #007bff;
            --border-color: #e0e0e0;
            --shadow: rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #ffffff;
            --header-color: #4dabf7;
            --border-color: #404040;
            --shadow: rgba(0,0,0,0.3);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow);
            padding: 30px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--header-color);
            position: relative;
        }
        .header h1 {
            color: var(--header-color);
            margin: 0;
            font-size: 2.2em;
        }
        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--header-color);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover {
            transform: scale(1.05);
            opacity: 0.8;
        }
        .header p {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        .race-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .race-card {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            background-color: var(--container-bg);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .race-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 15px rgba(0,123,255,0.2);
            transform: translateY(-2px);
        }
        .race-card.finished {
            opacity: 0.5;
            background-color: #f8f9fa;
            border-color: #d6d8db;
            cursor: not-allowed;
        }
        [data-theme="dark"] .race-card.finished {
            background-color: #3a3a3a;
            border-color: #555;
            color: #888;
        }
        .race-card.finished:hover {
            border-color: #d6d8db;
            box-shadow: none;
            transform: none;
        }
        .race-card.finished .race-venue {
            color: #6c757d;
        }
        .race-card.finished .race-number {
            background-color: #e9ecef;
            border-color: #adb5bd;
            color: #6c757d;
        }
        .race-card.finished .race-time {
            color: #adb5bd;
        }
        .finished-label {
            display: inline-block;
            background-color: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 8px;
        }
        .prediction-section {
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        .prediction-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .prediction-label {
            color: #666;
            font-weight: bold;
            flex: 0 0 auto;
        }
        .prediction-value {
            color: var(--header-color);
            font-weight: bold;
            text-align: right;
        }
        .result-value {
            color: #28a745;
            font-weight: bold;
            text-align: right;
        }
        .confidence-stars {
            color: #ffc107;
            font-size: 0.8em;
        }
        .hit-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75em;
            margin-left: 5px;
        }
        .hit-indicator.hit {
            background-color: #28a745;
            color: white;
        }
        .hit-indicator.miss {
            background-color: #dc3545;
            color: white;
        }
        .vs-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .vs-arrow {
            color: #666;
            font-size: 0.8em;
        }
        .race-venue {
            font-size: 1.3em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 8px;
        }
        .race-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .race-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #dc3545;
            background-color: #fff5f5;
            padding: 5px 12px;
            border-radius: 20px;
            border: 2px solid #dc3545;
        }
        .race-time {
            font-size: 1.1em;
            color: #28a745;
            font-weight: bold;
        }
        .confidence-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }
        .confidence-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }
        .confidence-value {
            font-size: 1.1em;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .confidence-high {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .confidence-medium {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .confidence-low {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .race-title {
            color: #666;
            font-size: 0.9em;
            margin-top: 8px;
            font-style: italic;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            text-align: center;
            font-size: 1.1em;
        }
        .loading {
            text-align: center;
            color: #666;
            font-size: 1.2em;
            padding: 40px;
        }
        /* „É≠„Éº„Éâ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÁî®CSS */
        .loading-section {
            text-align: center;
            padding: 40px;
            background-color: var(--container-bg);
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 4px solid var(--border-color);
            border-left: 4px solid var(--header-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text h3 {
            color: var(--header-color);
            margin-bottom: 20px;
        }
        
        #progress-bar {
            width: 100%;
            max-width: 400px;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            margin: 20px auto;
            overflow: hidden;
        }
        
        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--header-color), #4dabf7);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        #loading-message {
            color: var(--text-color);
            font-size: 1.1em;
            margin: 10px 0;
        }
        
        #loading-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        #loading-step {
            font-weight: bold;
            color: var(--header-color);
        }
        
        .race-card.loading-placeholder {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            .race-grid {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 1.8em;
            }
            .prediction-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                margin-bottom: 10px;
            }
            .prediction-value,
            .result-value {
                text-align: left;
            }
            .vs-display {
                flex-wrap: wrap;
            }
            .loading-section {
                padding: 30px 20px;
            }
            #progress-bar {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()">üåô „ÉÄ„Éº„ÇØ</button>
            <h1>üèÅ BoatraceOpenAPI</h1>
            <p>{{ current_time }} ÁèæÂú®„ÅÆ„É¨„Éº„ÇπÊÉÖÂ†±</p>
            <div style="margin-top: 15px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <a href="/accuracy" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 10px 20px; text-decoration: none; border-radius: 20px; font-weight: bold;">üìä ÁöÑ‰∏≠Áéá„É¨„Éù„Éº„Éà</a>
                <a href="/dashboard" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 20px; text-decoration: none; border-radius: 20px; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">üöÄ AIÁµ±Âêà„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</a>
            </div>
        </div>

        {% if error %}
        <div class="error-message">
            ‚ùå {{ error }}
        </div>
        {% else %}
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number">{{ total_races }}</div>
                <div class="stat-label">Êú¨Êó•ÈñãÂÇ¨„É¨„Éº„ÇπÊï∞</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ races|selectattr('start_time', 'ne', 'Êú™ÂÆö')|list|length }}</div>
                <div class="stat-label">Áô∫Ëµ∞ÊôÇÂàªÁ¢∫ÂÆö</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ races|map(attribute='venue_name')|unique|list|length }}</div>
                <div class="stat-label">ÈñãÂÇ¨Â†¥Êï∞</div>
            </div>
        </div>

        <!-- „É≠„Éº„Éâ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
        <div id="loading-indicator" class="loading-section">
            <div class="loading-spinner"></div>
            <div class="loading-text">
                <h3 id="loading-title">üìä „É¨„Éº„Çπ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</h3>
                <div id="progress-bar">
                    <div id="progress-fill"></div>
                </div>
                <p id="loading-message">„Éá„Éº„ÇøÂèñÂæó„ÇíÈñãÂßã„Åó„Å¶„ÅÑ„Åæ„Åô...</p>
                <div id="loading-details">
                    <span id="loading-step">Ê∫ñÂÇô‰∏≠</span> - 
                    <span id="loading-progress">0</span>/<span id="loading-total">5</span>
                </div>
            </div>
        </div>

        <!-- „É¨„Éº„Çπ‰∏ÄË¶ßÔºàÂãïÁöÑ„Å´ËøΩÂä†Ôºâ -->
        <div id="race-grid" class="race-grid" style="display: none;">
            <!-- JavaScript„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
        </div>

        <!-- „Ç®„É©„ÉºË°®Á§∫ -->
        <div id="error-section" class="error-message" style="display: none;">
            <span id="error-text"></span>
        </div>
        {% endif %}
    </div>

    <script>
        // „ÉÜ„Éº„ÉûÂàá„ÇäÊõø„ÅàÊ©üËÉΩ
        function toggleTheme() {
            const body = document.body;
            const button = document.querySelector('.theme-toggle');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                button.textContent = 'üåô „ÉÄ„Éº„ÇØ';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                button.textContent = '‚òÄÔ∏è „É©„Ç§„Éà';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„ÉÜ„Éº„Éû„ÇíÂæ©ÂÖÉ
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const button = document.querySelector('.theme-toggle');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                button.textContent = '‚òÄÔ∏è „É©„Ç§„Éà';
            }
            
            // ÈùûÂêåÊúü„Éá„Éº„Çø„É≠„Éº„Éâ„ÇíÈñãÂßã
            loadRaceData();
        });
        
        // „Éñ„É©„Ç¶„Ç∂„ÅÆÊàª„Çã„Éú„Çø„É≥„Åß„Éö„Éº„Ç∏„Å´Êàª„Å£„ÅüÂ†¥Âêà„ÇÇ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÊ¥ªÁî®
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                // „Éö„Éº„Ç∏„Åå bfcache „Åã„ÇâÂæ©ÂÖÉ„Åï„Çå„ÅüÂ†¥Âêà
                console.log('„Éö„Éº„Ç∏„Åå„Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâÂæ©ÂÖÉ„Åï„Çå„Åæ„Åó„Åü');
                const cachedData = getCachedRaceData();
                if (cachedData) {
                    displayRaceData(cachedData);
                }
            }
        });

        // „Çª„ÉÉ„Ç∑„Éß„É≥„Çπ„Éà„É¨„Éº„Ç∏„Ç≠„É£„ÉÉ„Ç∑„É•„Ç≠„Éº
        const RACE_DATA_CACHE_KEY = 'race_data_cache';
        const CACHE_EXPIRY_KEY = 'race_data_cache_expiry';
        const CACHE_DURATION = 5 * 60 * 1000; // 5ÂàÜÈñì„Ç≠„É£„ÉÉ„Ç∑„É•

        // „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâÂèñÂæó
        function getCachedRaceData() {
            try {
                const cachedData = sessionStorage.getItem(RACE_DATA_CACHE_KEY);
                const cacheExpiry = sessionStorage.getItem(CACHE_EXPIRY_KEY);
                
                if (cachedData && cacheExpiry) {
                    const expiry = parseInt(cacheExpiry);
                    if (Date.now() < expiry) {
                        console.log('„Ç≠„É£„ÉÉ„Ç∑„É•„Åã„Çâ„É¨„Éº„Çπ„Éá„Éº„Çø„ÇíÂèñÂæó');
                        return JSON.parse(cachedData);
                    }
                }
                return null;
            } catch (error) {
                console.warn('„Ç≠„É£„ÉÉ„Ç∑„É•ÂèñÂæó„Ç®„É©„Éº:', error);
                return null;
            }
        }

        // „Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò
        function setCachedRaceData(data) {
            try {
                sessionStorage.setItem(RACE_DATA_CACHE_KEY, JSON.stringify(data));
                sessionStorage.setItem(CACHE_EXPIRY_KEY, (Date.now() + CACHE_DURATION).toString());
                console.log('„É¨„Éº„Çπ„Éá„Éº„Çø„Çí„Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò');
            } catch (error) {
                console.warn('„Ç≠„É£„ÉÉ„Ç∑„É•‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }

        // „Ç≠„É£„ÉÉ„Ç∑„É•„Åï„Çå„Åü„Éá„Éº„Çø„ÇíË°®Á§∫
        async function displayRaceData(cachedData) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const raceGrid = document.getElementById('race-grid');
            const stats = document.querySelector('.stats');
            
            // „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„Çâ„ÅÆ„Éá„Éº„ÇøË°®Á§∫„ÅØÂç≥Â∫ß„Å´Ë°å„ÅÜ
            loadingIndicator.style.display = 'none';
            raceGrid.style.display = 'grid';
            
            // „É¨„Éº„Çπ„Éá„Éº„ÇøË°®Á§∫
            displayRaces(cachedData.races);
            
            // Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
            updateStats(cachedData.races);
            
            // „Ç≠„É£„ÉÉ„Ç∑„É•„Åï„Çå„Åü„Éá„Éº„Çø„Å´‰∫àÊÉ≥ÊÉÖÂ†±„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶Ë°®Á§∫
            displayCachedPredictions(cachedData.races);
            
            // „Éõ„Éê„ÉºÂäπÊûúË®≠ÂÆö
            setupHoverEffects();
            
            console.log(`„Ç≠„É£„ÉÉ„Ç∑„É•„Åã„Çâ${cachedData.races.length}‰ª∂„ÅÆ„É¨„Éº„Çπ„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü`);
        }

        // ÈùûÂêåÊúü„É¨„Éº„Çπ„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÊ©üËÉΩ
        async function loadRaceData() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const raceGrid = document.getElementById('race-grid');
            const errorSection = document.getElementById('error-section');
            const stats = document.querySelector('.stats');
            
            try {
                // Step 0: „Ç≠„É£„ÉÉ„Ç∑„É•„ÉÅ„Çß„ÉÉ„ÇØ
                const cachedData = getCachedRaceData();
                if (cachedData) {
                    console.log('„Ç≠„É£„ÉÉ„Ç∑„É•„Åã„Çâ„Éá„Éº„ÇøË°®Á§∫');
                    displayRaceData(cachedData);
                    return;
                }

                // Step 1: Âü∫Êú¨„Éá„Éº„ÇøÂèñÂæó
                updateLoadingProgress('„Éá„Éº„ÇøÂèñÂæó', 1, 4, '„É¨„Éº„Çπ„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠...');
                
                const response = await fetch('/api/races/async');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || '„Éá„Éº„ÇøÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
                
                // Step 2: Âü∫Êú¨„É¨„Éº„ÇπÊÉÖÂ†±Ë°®Á§∫
                updateLoadingProgress('Ë°®Á§∫Ê∫ñÂÇô', 2, 4, '„É¨„Éº„ÇπÊÉÖÂ†±„ÇíÊ∫ñÂÇô‰∏≠...');
                await new Promise(resolve => setTimeout(resolve, 500)); // UXÂêë‰∏ä„ÅÆ„Åü„ÇÅ„ÅÆÂ∞ë„Åó„ÅÆÂæÖÊ©ü
                
                const races = data.races;
                displayRaces(races);
                
                // Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
                updateStats(races);
                
                // Step 3: AI‰∫àÊÉ≥„Éá„Éº„ÇøÂèñÂæó
                updateLoadingProgress('AI‰∫àÊÉ≥Ë®àÁÆó', 3, 4, 'AI‰∫àÊÉ≥„ÇíË®àÁÆó‰∏≠...');
                await loadPredictions(races);
                
                // Step 4: ÂÆå‰∫Ü„Å®„Ç≠„É£„ÉÉ„Ç∑„É•‰øùÂ≠ò
                updateLoadingProgress('ÂÆå‰∫Ü', 4, 4, `${races.length}‰ª∂„ÅÆ„É¨„Éº„Çπ„ÇíÂèñÂæóÂÆå‰∫Ü`);
                
                // „Éá„Éº„Çø„Çí„Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò
                setCachedRaceData({
                    races: races,
                    timestamp: Date.now(),
                    stats: {
                        total: races.length,
                        finished: races.filter(r => r.is_finished).length
                    }
                });
                
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞„ÇíÈö†„Åó„Å¶„É¨„Éº„Çπ„Ç∞„É™„ÉÉ„Éâ„ÇíË°®Á§∫
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                    raceGrid.style.display = 'grid';
                    
                    // „Éõ„Éê„ÉºÂäπÊûú„ÇíÂÜçË®≠ÂÆö
                    setupHoverEffects();
                }, 1000);
                
            } catch (error) {
                console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                showError(error.message);
            }
        }

        // ÈÄ≤ÊçóÊõ¥Êñ∞
        function updateLoadingProgress(step, progress, total, message) {
            const progressPercent = (progress / total) * 100;
            
            document.getElementById('loading-step').textContent = step;
            document.getElementById('loading-progress').textContent = progress;
            document.getElementById('loading-total').textContent = total;
            document.getElementById('loading-message').textContent = message;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
        }

        // „É¨„Éº„ÇπË°®Á§∫
        function displayRaces(races) {
            const raceGrid = document.getElementById('race-grid');
            raceGrid.innerHTML = '';
            
            races.forEach(race => {
                const raceCard = createRaceCard(race);
                raceGrid.appendChild(raceCard);
            });
        }

        // ‰ø°È†ºÂ∫¶ÂàÜÈ°ûÈñ¢Êï∞
        function getConfidenceClass(confidence) {
            if (confidence >= 70) return 'confidence-high';
            if (confidence >= 55) return 'confidence-medium';
            return 'confidence-low';
        }

        // „É¨„Éº„Çπ„Ç´„Éº„Éâ‰ΩúÊàê
        function createRaceCard(race) {
            const div = document.createElement('div');
            div.className = `race-card ${race.is_finished ? 'finished' : ''}`;
            div.onclick = () => {
                if (!race.is_finished) {
                    location.href = `/predict/${race.race_id}`;
                }
            };
            
            // ‰ø°È†ºÂ∫¶„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏Ë®àÁÆóÔºàÁµ±‰∏Ä‰ø°È†ºÂ∫¶ÂØæÂøúÔºâ
            const confidencePercent = race.unified_confidence ? 
                Math.round(race.unified_confidence * 100) : 
                (race.confidence ? Math.round(race.confidence) : 50);
            
            div.innerHTML = `
                <div class="race-venue">
                    ${race.venue_name}
                    ${race.is_finished ? '<span class="finished-label">ÁµÇ‰∫Ü</span>' : ''}
                </div>
                <div class="race-info">
                    <div class="race-number">${race.race_number}R</div>
                    <div class="race-time">${race.start_time}</div>
                </div>
                <div class="confidence-display">
                    <span class="confidence-label">‰ø°È†ºÂ∫¶:</span>
                    <span class="confidence-value ${getConfidenceClass(confidencePercent)}">${confidencePercent}%</span>
                </div>
                ${race.race_title ? `<div class="race-title">${race.race_title}</div>` : ''}
                <div id="prediction-${race.race_id}" class="prediction-section" style="display: none;">
                    <!-- ‰∫àÊÉ≥„Éá„Éº„Çø„ÅØÂæå„ÅßËøΩÂä† -->
                </div>
            `;
            
            return div;
        }

        // „Ç≠„É£„ÉÉ„Ç∑„É•„Åï„Çå„Åü‰∫àÊÉ≥„Éá„Éº„Çø„ÇíË°®Á§∫
        function displayCachedPredictions(races) {
            races.forEach(race => {
                if (race.prediction) {
                    displayPredictionForRace(race.race_id, race.prediction);
                }
            });
        }
        
        // ÂÄãÂà•„É¨„Éº„Çπ„ÅÆ‰∫àÊÉ≥„Éá„Éº„Çø„ÇíË°®Á§∫
        function displayPredictionForRace(raceId, prediction) {
            const predictionSection = document.getElementById(`prediction-${raceId}`);
            if (!predictionSection || !prediction) return;
            
            let html = '';
            
            if (prediction.predicted_win) {
                html += `
                    <div class="prediction-row">
                        <span>üèÜ ÂçòÂãùÊé®Â•®:</span>
                        <span class="prediction-value">${prediction.predicted_win}Âè∑Ëâá</span>
                    </div>
                `;
            }
            
            if (prediction.predicted_place && prediction.predicted_place.length > 0) {
                html += `
                    <div class="prediction-row">
                        <span>üéØ Ë§áÂãùÊé®Â•®:</span>
                        <span class="prediction-value">${prediction.predicted_place.join('-')}Âè∑Ëâá</span>
                    </div>
                `;
            }
            
            if (prediction.confidence) {
                const confidencePercent = Math.round(prediction.confidence * 100);
                const stars = generateConfidenceStars(prediction.confidence);
                html += `
                    <div class="prediction-row">
                        <span>‚≠ê ‰∫àÊÉ≥Á≤æÂ∫¶:</span>
                        <span class="prediction-confidence">${stars} ${confidencePercent}%</span>
                    </div>
                `;
            }
            
            if (html) {
                predictionSection.innerHTML = html;
                predictionSection.style.display = 'block';
            }
        }

        // AI‰∫àÊÉ≥„Éá„Éº„ÇøÂèñÂæó
        async function loadPredictions(races) {
            try {
                const response = await fetch('/api/races');
                const data = await response.json();
                
                if (data.success && data.races) {
                    data.races.forEach(fullRace => {
                        if (fullRace.prediction) {
                            updateRacePrediction(fullRace);
                        }
                    });
                }
            } catch (error) {
                console.warn('‰∫àÊÉ≥„Éá„Éº„ÇøÂèñÂæóÂ§±Êïó:', error);
                // ‰∫àÊÉ≥„Éá„Éº„ÇøÂèñÂæóÂ§±Êïó„ÅØËá¥ÂëΩÁöÑ„Ç®„É©„Éº„Åß„ÅØ„Å™„ÅÑ„ÅÆ„ÅßÁ∂öË°å
            }
        }

        // „É¨„Éº„Çπ‰∫àÊÉ≥Êõ¥Êñ∞
        function updateRacePrediction(race) {
            const predictionSection = document.getElementById(`prediction-${race.race_id}`);
            if (!predictionSection || !race.prediction) return;
            
            const prediction = race.prediction;
            const result = race.result;
            
            let html = '';
            
            // ‰∫àÊÉ≥„Éá„Éº„Çø
            if (prediction) {
                const confidenceStars = generateConfidenceStars(prediction.confidence);
                
                html += `
                    <div class="prediction-row">
                        <span class="prediction-label">AI‰∫àÊÉ≥:</span>
                        <div class="prediction-value">
                            ${prediction.predicted_win}Âè∑Ëâá
                            <div class="confidence-stars">${confidenceStars}</div>
                        </div>
                    </div>
                `;
                
                if (prediction.predicted_place && prediction.predicted_place.length > 0) {
                    html += `
                        <div class="prediction-row">
                            <span class="prediction-label">Ë§áÂãù:</span>
                            <span class="prediction-value">
                                ${prediction.predicted_place.slice(0, 3).join('-')}Âè∑Ëâá
                            </span>
                        </div>
                    `;
                }
            }
            
            // ÁµêÊûú„Éá„Éº„Çø
            if (result) {
                html += `
                    <div class="prediction-row">
                        <span class="prediction-label">ÂÆüÈöõ:</span>
                        <div class="vs-display">
                            ${prediction ? `<span class="prediction-value">${prediction.predicted_win}Âè∑Ëâá</span><span class="vs-arrow">‚Üí</span>` : ''}
                            <span class="result-value">
                                ${result.winning_boat}Âè∑Ëâá
                                ${prediction ? `<span class="hit-indicator ${prediction.predicted_win == result.winning_boat ? 'hit' : 'miss'}">${prediction.predicted_win == result.winning_boat ? '‚úì' : '‚úó'}</span>` : ''}
                            </span>
                        </div>
                    </div>
                `;
                
                if (result.place_results && result.place_results.length > 0) {
                    html += `
                        <div class="prediction-row">
                            <span class="prediction-label">ÁùÄÈ†Ü:</span>
                            <span class="result-value">
                                ${result.place_results.slice(0, 3).join('-')}Âè∑Ëâá
                            </span>
                        </div>
                    `;
                }
            }
            
            if (html) {
                predictionSection.innerHTML = html;
                predictionSection.style.display = 'block';
            }
        }

        // ‰ø°È†ºÂ∫¶ÊòüÁîüÊàê
        function generateConfidenceStars(confidence) {
            const totalStars = 5;
            const filledStars = Math.floor((confidence || 0.5) * totalStars);
            const emptyStars = totalStars - filledStars;
            
            return '‚òÖ'.repeat(filledStars) + '‚òÜ'.repeat(emptyStars);
        }

        // Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
        function updateStats(races) {
            const totalRaces = races.length;
            const confirmedTimes = races.filter(race => race.start_time !== 'Êú™ÂÆö').length;
            const venues = new Set(races.map(race => race.venue_name)).size;
            
            document.querySelector('.stats').innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${totalRaces}</div>
                    <div class="stat-label">Êú¨Êó•ÈñãÂÇ¨„É¨„Éº„ÇπÊï∞</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${confirmedTimes}</div>
                    <div class="stat-label">Áô∫Ëµ∞ÊôÇÂàªÁ¢∫ÂÆö</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${venues}</div>
                    <div class="stat-label">ÈñãÂÇ¨Â†¥Êï∞</div>
                </div>
            `;
        }

        // „Ç®„É©„ÉºË°®Á§∫
        function showError(message) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorSection = document.getElementById('error-section');
            const errorText = document.getElementById('error-text');
            
            loadingIndicator.style.display = 'none';
            errorText.textContent = `‚ùå ${message}`;
            errorSection.style.display = 'block';
        }

        // „Éõ„Éê„ÉºÂäπÊûúË®≠ÂÆö
        function setupHoverEffects() {
            document.querySelectorAll('.race-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    const isDark = document.body.getAttribute('data-theme') === 'dark';
                    this.style.background = isDark ? 
                        'linear-gradient(135deg, #3d3d3d 0%, #4a4a4a 100%)' :
                        'linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.background = '';
                });
            });
        }

        // Ëá™Âãï„É™„É≠„Éº„ÉâÔºà5ÂàÜÈñìÈöîÔºâ
        setTimeout(function() {
            location.reload();
        }, 300000);
    </script>
</body>
</html>