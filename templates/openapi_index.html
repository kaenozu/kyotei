<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¶è‰‡äºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ  - ä»Šæ—¥ã®ãƒ¬ãƒ¼ã‚¹</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #333;
            --header-color: #007bff;
            --border-color: #e0e0e0;
            --shadow: rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #ffffff;
            --header-color: #4dabf7;
            --border-color: #404040;
            --shadow: rgba(0,0,0,0.3);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow);
            padding: 30px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--header-color);
            position: relative;
        }
        .header h1 {
            color: var(--header-color);
            margin: 0;
            font-size: 2.2em;
        }
        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--header-color);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover {
            transform: scale(1.05);
            opacity: 0.8;
        }
        .header p {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        .race-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .race-card {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            background-color: var(--container-bg);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .race-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 15px rgba(0,123,255,0.2);
            transform: translateY(-2px);
        }
        .race-card.finished {
            opacity: 0.5;
            background-color: #f8f9fa;
            border-color: #d6d8db;
            cursor: not-allowed;
        }
        [data-theme="dark"] .race-card.finished {
            background-color: #3a3a3a;
            border-color: #555;
            color: #888;
        }
        .race-card.finished:hover {
            border-color: #d6d8db;
            box-shadow: none;
            transform: none;
        }
        .race-card.finished .race-venue {
            color: #6c757d;
        }
        .race-card.finished .race-number {
            background-color: #e9ecef;
            border-color: #adb5bd;
            color: #6c757d;
        }
        .race-card.finished .race-time {
            color: #adb5bd;
        }
        .finished-label {
            display: inline-block;
            background-color: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 8px;
        }
        .prediction-section {
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        .prediction-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .prediction-label {
            color: #666;
            font-weight: bold;
            flex: 0 0 auto;
        }
        .prediction-value {
            color: var(--header-color);
            font-weight: bold;
            text-align: right;
        }
        .result-row {
            background-color: #f8f9fa;
            border-left: 4px solid #28a745;
            padding-left: 8px;
        }
        .result-value {
            color: #28a745;
            font-weight: bold;
            text-align: right;
        }
        .hit-status .hit {
            color: #28a745;
            font-weight: bold;
        }
        .hit-status .miss {
            color: #dc3545;
            font-weight: bold;
        }
        .confidence-stars {
            color: #ffc107;
            font-size: 0.8em;
        }
        .hit-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75em;
            margin-left: 5px;
        }
        .hit-indicator.hit {
            background-color: #28a745;
            color: white;
        }
        .hit-indicator.miss {
            background-color: #dc3545;
            color: white;
        }
        .vs-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .vs-arrow {
            color: #666;
            font-size: 0.8em;
        }
        .race-venue {
            font-size: 1.3em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 8px;
        }
        .race-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .race-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #dc3545;
            background-color: #fff5f5;
            padding: 5px 12px;
            border-radius: 20px;
            border: 2px solid #dc3545;
        }
        .race-time {
            font-size: 1.1em;
            color: #28a745;
            font-weight: bold;
        }
        .confidence-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }
        .confidence-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }
        .confidence-value {
            font-size: 1.1em;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .confidence-high {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .confidence-medium {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .confidence-low {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .race-title {
            color: #666;
            font-size: 0.9em;
            margin-top: 8px;
            font-style: italic;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            text-align: center;
            font-size: 1.1em;
        }
        .loading {
            text-align: center;
            color: #666;
            font-size: 1.2em;
            padding: 40px;
        }
        /* ãƒ­ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ç”¨CSS */
        .loading-section {
            text-align: center;
            padding: 40px;
            background-color: var(--container-bg);
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 4px solid var(--border-color);
            border-left: 4px solid var(--header-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text h3 {
            color: var(--header-color);
            margin-bottom: 20px;
        }
        
        #progress-bar {
            width: 100%;
            max-width: 400px;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            margin: 20px auto;
            overflow: hidden;
        }
        
        #progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--header-color), #4dabf7);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        #loading-message {
            color: var(--text-color);
            font-size: 1.1em;
            margin: 10px 0;
        }
        
        #loading-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        #loading-step {
            font-weight: bold;
            color: var(--header-color);
        }
        
        .race-card.loading-placeholder {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            .race-grid {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 1.8em;
            }
            .prediction-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                margin-bottom: 10px;
            }
            .prediction-value,
            .result-value {
                text-align: left;
            }
            .vs-display {
                flex-wrap: wrap;
            }
            .loading-section {
                padding: 30px 20px;
            }
            #progress-bar {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</button>
            <h1>ğŸ ç«¶è‰‡äºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>{{ current_time }} ç¾åœ¨ã®ãƒ¬ãƒ¼ã‚¹æƒ…å ±</p>
            <div style="margin-top: 15px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; align-items: center;">
                <a href="/accuracy" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 10px 20px; text-decoration: none; border-radius: 20px; font-weight: bold;">ğŸ“Š çš„ä¸­ç‡ãƒ¬ãƒãƒ¼ãƒˆ</a>
                <a href="/dashboard" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 20px; text-decoration: none; border-radius: 20px; font-weight: bold; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">ğŸš€ AIçµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label for="date-select" style="color: #666; font-size: 0.9em;">ğŸ“… æ—¥ä»˜:</label>
                    <input type="date" id="date-select" value="{% if selected_date %}{{ selected_date }}{% else %}{{ today_date }}{% endif %}" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 0.9em;" onchange="changeDate(this.value)">
                </div>
            </div>
        </div>

        {% if error %}
        <div class="error-message">
            âŒ {{ error }}
        </div>
        {% else %}
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number">{{ total_races }}</div>
                <div class="stat-label">æœ¬æ—¥é–‹å‚¬ãƒ¬ãƒ¼ã‚¹æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ races|selectattr('start_time', 'ne', 'æœªå®š')|list|length }}</div>
                <div class="stat-label">ç™ºèµ°æ™‚åˆ»ç¢ºå®š</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ races|map(attribute='venue_name')|unique|list|length }}</div>
                <div class="stat-label">é–‹å‚¬å ´æ•°</div>
            </div>
            <div class="stat-item">
                <button onclick="forceClearCache()" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 8px 16px; border: none; border-radius: 15px; font-size: 0.8em; cursor: pointer; font-weight: bold;" title="å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶å‰Šé™¤">ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢</button>
            </div>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
        <div id="loading-indicator" class="loading-section">
            <div class="loading-spinner"></div>
            <div class="loading-text">
                <h3 id="loading-title">ğŸ“Š ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</h3>
                <div id="progress-bar">
                    <div id="progress-fill"></div>
                </div>
                <p id="loading-message">ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</p>
                <div id="loading-details">
                    <span id="loading-step">æº–å‚™ä¸­</span> - 
                    <span id="loading-progress">0</span>/<span id="loading-total">5</span>
                </div>
            </div>
        </div>

        <!-- ãƒ¬ãƒ¼ã‚¹ä¸€è¦§ï¼ˆå‹•çš„ã«è¿½åŠ ï¼‰ -->
        <div id="race-grid" class="race-grid" style="display: none;">
            <!-- JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
        </div>

        <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
        <div id="error-section" class="error-message" style="display: none;">
            <span id="error-text"></span>
        </div>
        {% endif %}
    </div>

    <script>
        // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function toggleTheme() {
            const body = document.body;
            const button = document.querySelector('.theme-toggle');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                button.textContent = 'ğŸŒ™ ãƒ€ãƒ¼ã‚¯';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                button.textContent = 'â˜€ï¸ ãƒ©ã‚¤ãƒˆ';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ†ãƒ¼ãƒã‚’å¾©å…ƒ
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const button = document.querySelector('.theme-toggle');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                button.textContent = 'â˜€ï¸ ãƒ©ã‚¤ãƒˆ';
            }
            
            // å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ã‚¯ãƒªã‚¢ï¼ˆå½“æ—¥ä»¥å¤–ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ï¼‰
            checkAndClearOldCache();
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¼·åˆ¶ã‚¯ãƒªã‚¢ã—ã¦æ–°è¦ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
            sessionStorage.removeItem(RACE_DATA_CACHE_KEY);
            sessionStorage.removeItem(CACHE_EXPIRY_KEY);
            console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¼·åˆ¶ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            
            // äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿è¾¼ã¿ã®çµ±åˆAPIã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
            loadRaceDataFromFullAPI();
        });
        
        // ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³ã§ãƒšãƒ¼ã‚¸ã«æˆ»ã£ãŸå ´åˆã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                // ãƒšãƒ¼ã‚¸ãŒ bfcache ã‹ã‚‰å¾©å…ƒã•ã‚ŒãŸå ´åˆ
                console.log('ãƒšãƒ¼ã‚¸ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒã•ã‚Œã¾ã—ãŸ');
                const cachedData = getCachedRaceData();
                if (cachedData) {
                    displayRaceData(cachedData);
                }
            }
        });

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
        const RACE_DATA_CACHE_KEY = 'race_data_cache';
        const CACHE_EXPIRY_KEY = 'race_data_cache_expiry';
        const CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—
        function getCachedRaceData() {
            try {
                const cachedData = sessionStorage.getItem(RACE_DATA_CACHE_KEY);
                const cacheExpiry = sessionStorage.getItem(CACHE_EXPIRY_KEY);
                
                if (cachedData && cacheExpiry) {
                    const expiry = parseInt(cacheExpiry);
                    if (Date.now() < expiry) {
                        console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—');
                        return JSON.parse(cachedData);
                    }
                }
                return null;
            } catch (error) {
                console.warn('ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        function setCachedRaceData(data) {
            try {
                sessionStorage.setItem(RACE_DATA_CACHE_KEY, JSON.stringify(data));
                sessionStorage.setItem(CACHE_EXPIRY_KEY, (Date.now() + CACHE_DURATION).toString());
                console.log('ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜');
            } catch (error) {
                console.warn('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒ»ã‚¯ãƒªã‚¢æ©Ÿèƒ½
        function checkAndClearOldCache() {
            try {
                const cachedData = sessionStorage.getItem(RACE_DATA_CACHE_KEY);
                if (cachedData) {
                    const data = JSON.parse(cachedData);
                    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                    
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ä¸­ã«æ˜ã‚‰ã‹ã«å¤ã„ï¼ˆä»Šæ—¥ä»¥å¤–ã®ï¼‰ãƒ¬ãƒ¼ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    if (data.races && data.races.length > 0) {
                        const hasOldRaces = data.races.some(race => {
                            if (race.start_time && race.start_time !== 'æœªå®š') {
                                const raceDate = race.start_time.split(' ')[0];
                                return raceDate !== today;
                            }
                            return false;
                        });
                        
                        if (hasOldRaces) {
                            console.log('å¤ã„ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è‡ªå‹•ã‚¯ãƒªã‚¢');
                            sessionStorage.removeItem(RACE_DATA_CACHE_KEY);
                            sessionStorage.removeItem(CACHE_EXPIRY_KEY);
                        }
                    }
                }
            } catch (error) {
                console.warn('å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å®‰å…¨ã®ãŸã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
                sessionStorage.removeItem(RACE_DATA_CACHE_KEY);
                sessionStorage.removeItem(CACHE_EXPIRY_KEY);
            }
        }
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¼·åˆ¶ã‚¯ãƒªã‚¢æ©Ÿèƒ½
        function forceClearCache() {
            try {
                sessionStorage.removeItem(RACE_DATA_CACHE_KEY);
                sessionStorage.removeItem(CACHE_EXPIRY_KEY);
                console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¼·åˆ¶ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                
                // ã‚µãƒ¼ãƒãƒ¼å´ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ã‚¯ãƒªã‚¢
                fetch('/api/races/clear-cache')
                    .then(response => response.json())
                    .then(data => {
                        console.log('ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢:', data.message);
                        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                        location.reload();
                    })
                    .catch(error => {
                        console.warn('ã‚µãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                        location.reload();
                    });
                    
            } catch (error) {
                console.warn('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                location.reload();
            }
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        async function displayRaceData(cachedData) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const raceGrid = document.getElementById('race-grid');
            const stats = document.querySelector('.stats');
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã¯å³åº§ã«è¡Œã†
            loadingIndicator.style.display = 'none';
            raceGrid.style.display = 'grid';
            
            // ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
            displayRaces(cachedData.races);
            
            // çµ±è¨ˆæƒ…å ±æ›´æ–°
            updateStats(cachedData.races);
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«äºˆæƒ³æƒ…å ±ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦è¡¨ç¤º
            displayCachedPredictions(cachedData.races);
            
            // ãƒ›ãƒãƒ¼åŠ¹æœè¨­å®š
            setupHoverEffects();
            
            console.log(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰${cachedData.races.length}ä»¶ã®ãƒ¬ãƒ¼ã‚¹ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯ä»˜ããƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆæ”¹å–„ç‰ˆï¼‰
        async function loadRaceDataWithCacheCheck() {
            const cachedData = getCachedRaceData();
            
            if (cachedData && cachedData.races && cachedData.races.length > 0) {
                // æœ‰åŠ¹ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹å ´åˆï¼šå³åº§ã«è¡¨ç¤ºã—ã¦ã‹ã‚‰èƒŒæ™¯ã§æ›´æ–°
                console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã€èƒŒæ™¯ã§æ›´æ–°ã—ã¾ã™');
                displayRaceData(cachedData);
                
                // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ãªå ´åˆã‚„å¤ã„å ´åˆã¯èƒŒæ™¯ã§æ›´æ–°
                const now = Date.now();
                const cacheAge = now - cachedData.timestamp;
                const hasMissingPredictions = cachedData.races.some(race => !race.prediction);
                
                if (cacheAge > 60000 || hasMissingPredictions) { // 1åˆ†ä»¥ä¸ŠçµŒéã¾ãŸã¯äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ä¸è¶³
                    console.log('èƒŒæ™¯ã§äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã™');
                    try {
                        await loadPredictions(cachedData.races);
                    } catch (error) {
                        console.warn('èƒŒæ™¯æ›´æ–°å¤±æ•—:', error);
                    }
                }
            } else {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„ã‹ç©ºã®å ´åˆï¼šãƒ•ãƒ«èª­ã¿è¾¼ã¿
                if (cachedData && cachedData.races && cachedData.races.length === 0) {
                    console.log('ç©ºã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ¤œå‡ºã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã—ã¦æ–°è¦ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿');
                    sessionStorage.removeItem(RACE_DATA_CACHE_KEY);
                    sessionStorage.removeItem(CACHE_EXPIRY_KEY);
                } else {
                    console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ã€æ–°è¦ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿');
                }
                await loadRaceData();
            }
        }

        // éåŒæœŸãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ©Ÿèƒ½
        async function loadRaceData() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const raceGrid = document.getElementById('race-grid');
            const errorSection = document.getElementById('error-section');
            const stats = document.querySelector('.stats');
            
            try {
                // ãƒ‡ãƒãƒƒã‚°: APIå‘¼ã³å‡ºã—é–‹å§‹
                console.log('æ–°è¦APIãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’é–‹å§‹ã—ã¾ã™');

                // Step 1: åŸºæœ¬ãƒ‡ãƒ¼ã‚¿å–å¾—
                updateLoadingProgress('ãƒ‡ãƒ¼ã‚¿å–å¾—', 1, 4, 'ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
                
                // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã‚’å–å¾—
                const selectedDate = getSelectedDate();
                const url = selectedDate ? `/api/races/basic?date=${selectedDate}` : '/api/races/basic';
                
                console.log('APIå‘¼ã³å‡ºã—URL:', url);
                const response = await fetch(url);
                console.log('APIå¿œç­”ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                const data = await response.json();
                console.log('APIå–å¾—ãƒ‡ãƒ¼ã‚¿:', data);
                
                // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
                console.log('[DEBUG] API response:', data);
                console.log('[DEBUG] data.success:', data.success);
                console.log('[DEBUG] data.races type:', typeof data.races);
                console.log('[DEBUG] data.races length:', data.races ? data.races.length : 'undefined');
                console.log('[DEBUG] First race sample:', data.races ? data.races[0] : 'no races');
                
                if (!data.success) {
                    throw new Error(data.error || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // Step 2: åŸºæœ¬ãƒ¬ãƒ¼ã‚¹æƒ…å ±è¡¨ç¤º
                updateLoadingProgress('è¡¨ç¤ºæº–å‚™', 2, 4, 'ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’æº–å‚™ä¸­...');
                await new Promise(resolve => setTimeout(resolve, 500)); // UXå‘ä¸Šã®ãŸã‚ã®å°‘ã—ã®å¾…æ©Ÿ
                
                const races = data.races;
                console.log('[DEBUG] About to call displayRaces with:', races);
                displayRaces(races);
                
                // çµ±è¨ˆæƒ…å ±æ›´æ–°
                updateStats(races);
                
                // Step 3: AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—
                updateLoadingProgress('AIäºˆæƒ³è¨ˆç®—', 3, 4, 'AIäºˆæƒ³ã‚’è¨ˆç®—ä¸­...');
                await loadPredictions(races);
                
                // Step 4: å®Œäº†ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
                updateLoadingProgress('å®Œäº†', 4, 4, `${races.length}ä»¶ã®ãƒ¬ãƒ¼ã‚¹ã‚’å–å¾—å®Œäº†`);
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                setCachedRaceData({
                    races: races,
                    timestamp: Date.now(),
                    stats: {
                        total: races.length,
                        finished: races.filter(r => r.is_finished).length
                    }
                });
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éš ã—ã¦ãƒ¬ãƒ¼ã‚¹ã‚°ãƒªãƒƒãƒ‰ã‚’è¡¨ç¤º
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                    raceGrid.style.display = 'grid';
                    
                    // ãƒ›ãƒãƒ¼åŠ¹æœã‚’å†è¨­å®š
                    setupHoverEffects();
                }, 1000);
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError(error.message);
            }
        }

        // äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿è¾¼ã¿çµ±åˆAPIä½¿ç”¨ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadRaceDataFromFullAPI() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const raceGrid = document.getElementById('race-grid');
            const errorSection = document.getElementById('error-section');
            
            try {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                loadingIndicator.style.display = 'block';
                raceGrid.style.display = 'none';
                errorSection.style.display = 'none';
                
                updateLoadingProgress('çµ±åˆãƒ‡ãƒ¼ã‚¿å–å¾—', 1, 2, 'äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿è¾¼ã¿ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—ä¸­...');
                console.log('äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿è¾¼ã¿çµ±åˆAPIã‚’å‘¼ã³å‡ºã—ã¾ã™: /api/races');
                
                // çµ±åˆAPIã‚’å‘¼ã³å‡ºã—ï¼ˆäºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚€ï¼‰
                const response = await fetch('/api/races');
                const data = await response.json();
                
                console.log('[DEBUG] Full API response:', data);
                console.log('[DEBUG] Total races:', data.races ? data.races.length : 0);
                console.log('[DEBUG] Sample race:', data.races && data.races[0]);
                
                if (!data.success || !data.races) {
                    throw new Error(data.error || 'ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                updateLoadingProgress('è¡¨ç¤ºæº–å‚™', 2, 2, 'ãƒ¬ãƒ¼ã‚¹è¡¨ç¤ºã‚’æº–å‚™ä¸­...');
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                displayRaces(data.races);
                
                // çµ±è¨ˆæƒ…å ±æ›´æ–°
                updateStats(data.races);
                
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                setCachedRaceData({
                    races: data.races,
                    timestamp: Date.now(),
                    stats: {
                        total: data.races.length,
                        finished: data.races.filter(r => r.is_finished).length
                    }
                });
                
                // å®Œäº†
                loadingIndicator.style.display = 'none';
                raceGrid.style.display = 'grid';
                
                console.log(`çµ±åˆAPIã‹ã‚‰${data.races.length}ä»¶ã®ãƒ¬ãƒ¼ã‚¹ã‚’è¡¨ç¤ºï¼ˆäºˆæ¸¬ãƒ‡ãƒ¼ã‚¿å«ã‚€ï¼‰`);
                
            } catch (error) {
                console.error('çµ±åˆAPIèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError(`ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        // é€²æ—æ›´æ–°
        function updateLoadingProgress(step, progress, total, message) {
            const progressPercent = (progress / total) * 100;
            
            document.getElementById('loading-step').textContent = step;
            document.getElementById('loading-progress').textContent = progress;
            document.getElementById('loading-total').textContent = total;
            document.getElementById('loading-message').textContent = message;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
        }

        // ãƒ¬ãƒ¼ã‚¹è¡¨ç¤º
        function displayRaces(races) {
            console.log('[DEBUG] displayRaces called with:', races);
            console.log('[DEBUG] races is Array?', Array.isArray(races));
            console.log('[DEBUG] races length:', races ? races.length : 'races is null/undefined');
            
            const raceGrid = document.getElementById('race-grid');
            raceGrid.innerHTML = '';
            
            if (!races || !Array.isArray(races)) {
                console.error('[ERROR] races is not an array:', races);
                raceGrid.innerHTML = '<div class="error-message">ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            races.forEach((race, index) => {
                console.log(`[DEBUG] Processing race ${index}:`, race);
                const raceCard = createRaceCard(race);
                raceGrid.appendChild(raceCard);
            });
        }

        // ä¿¡é ¼åº¦åˆ†é¡é–¢æ•°
        function getConfidenceClass(confidence) {
            if (confidence >= 70) return 'confidence-high';
            if (confidence >= 55) return 'confidence-medium';
            return 'confidence-low';
        }

        // ãƒ¬ãƒ¼ã‚¹ã‚«ãƒ¼ãƒ‰ä½œæˆ
        function createRaceCard(race) {
            console.log('[DEBUG] createRaceCard called with race:', race);
            console.log('[DEBUG] race.venue_name:', race.venue_name);
            console.log('[DEBUG] race.race_number:', race.race_number);
            console.log('[DEBUG] race.start_time:', race.start_time);
            console.log('[DEBUG] race.race_title:', race.race_title);
            console.log('[DEBUG] race.race_id:', race.race_id);
            
            const div = document.createElement('div');
            div.className = `race-card ${race.is_finished ? 'finished' : ''}`;
            div.onclick = () => {
                if (!race.is_finished) {
                    location.href = `/predict/${race.race_id}`;
                }
            };
            
            // ä¿¡é ¼åº¦ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¨ˆç®—ï¼ˆä¿®æ­£ç‰ˆï¼‰
            let confidencePercent = 50; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            
            if (race.prediction && race.prediction.confidence !== undefined) {
                // prediction.confidence ã®å€¤ã‚’ä½¿ç”¨ï¼ˆ0.5 -> 50%å¤‰æ›ï¼‰
                confidencePercent = Math.round(race.prediction.confidence * 100);
            } else if (race.unified_confidence) {
                // unified_confidence ãŒã‚ã‚‹å ´åˆï¼ˆ0-1ç¯„å›²ã§100å€ï¼‰
                confidencePercent = Math.round(race.unified_confidence * 100);
            } else if (race.confidence && race.confidence > 1) {
                // confidence ãŒæ—¢ã«ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã®å ´åˆ
                confidencePercent = Math.round(race.confidence);
            } else if (race.confidence) {
                // confidence ãŒ0-1ç¯„å›²ã®å ´åˆï¼ˆ100å€ï¼‰
                confidencePercent = Math.round(race.confidence * 100);
            }
            
            // äºˆæ¸¬ãƒ»çµæœãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ±ºå®š
            const hasPredictionOrResult = race.prediction || race.result;
            const predictionDisplay = hasPredictionOrResult ? 'block' : 'none';
            
            div.innerHTML = `
                <div class="race-venue">
                    ${race.venue_name}
                    ${race.is_finished ? '<span class="finished-label">çµ‚äº†</span>' : ''}
                </div>
                <div class="race-info">
                    <div class="race-number">${race.race_number}R</div>
                    <div class="race-time">${race.start_time}</div>
                </div>
                <div class="confidence-display">
                    <span class="confidence-label">ä¿¡é ¼åº¦:</span>
                    <span class="confidence-value ${getConfidenceClass(confidencePercent)}">${confidencePercent}%</span>
                </div>
                ${race.race_title ? `<div class="race-title">${race.race_title}</div>` : ''}
                <div id="prediction-${race.race_id}" class="prediction-section" style="display: ${predictionDisplay};">
                    <!-- äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã¯å¾Œã§è¿½åŠ  -->
                </div>
            `;
            
            // äºˆæ¸¬ãƒ»çµæœãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å³åº§ã«è¡¨ç¤º
            if (hasPredictionOrResult) {
                setTimeout(() => {
                    displayPredictionForRace(race.race_id, race.prediction, race.result);
                }, 0);
            }
            
            return div;
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼‰
        function displayCachedPredictions(races) {
            races.forEach(race => {
                if (race.prediction || race.result) {
                    displayPredictionForRace(race.race_id, race.prediction, race.result);
                }
            });
        }
        
        // å€‹åˆ¥ãƒ¬ãƒ¼ã‚¹ã®äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼‰
        function displayPredictionForRace(raceId, prediction, result = null) {
            const predictionSection = document.getElementById(`prediction-${raceId}`);
            if (!predictionSection || (!prediction && !result)) return;
            
            let html = '';
            
            // çµæœãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯çµæœã‚’å„ªå…ˆè¡¨ç¤º
            if (result && result.winning_boat) {
                const placeResults = result.place_results || [];
                html += `
                    <div class="prediction-row result-row">
                        <span>ğŸ çµæœ:</span>
                        <span class="result-value">1ä½: ${result.winning_boat}å·è‰‡</span>
                    </div>
                `;
                
                if (placeResults.length >= 3) {
                    html += `
                        <div class="prediction-row result-row">
                            <span>ğŸ“Š ç€é †:</span>
                            <span class="result-value">${placeResults[0]}-${placeResults[1]}-${placeResults[2]}</span>
                        </div>
                    `;
                }
                
                // äºˆæƒ³ãŒçš„ä¸­ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
                if (prediction && prediction.predicted_win) {
                    const isHit = prediction.predicted_win === result.winning_boat;
                    const hitStatus = isHit ? 'âœ… çš„ä¸­!' : 'âŒ å¤–ã‚Œ';
                    html += `
                        <div class="prediction-row hit-status">
                            <span>ğŸ¯ å˜å‹:</span>
                            <span class="hit-status ${isHit ? 'hit' : 'miss'}">${hitStatus}</span>
                        </div>
                    `;
                }
            }
            
            // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤º
            if (prediction && prediction.predicted_win) {
                html += `
                    <div class="prediction-row">
                        <span>ğŸ† å˜å‹æ¨å¥¨:</span>
                        <span class="prediction-value">${prediction.predicted_win}å·è‰‡</span>
                    </div>
                `;
            }
            
            if (prediction && prediction.predicted_place && prediction.predicted_place.length > 0) {
                html += `
                    <div class="prediction-row">
                        <span>ğŸ¯ è¤‡å‹æ¨å¥¨:</span>
                        <span class="prediction-value">${prediction.predicted_place.join('-')}å·è‰‡</span>
                    </div>
                `;
            }
            
            if (prediction && prediction.confidence) {
                const confidencePercent = Math.round(prediction.confidence * 100);
                const stars = generateConfidenceStars(prediction.confidence);
                html += `
                    <div class="prediction-row">
                        <span>â­ äºˆæƒ³ç²¾åº¦:</span>
                        <span class="prediction-confidence">${stars} ${confidencePercent}%</span>
                    </div>
                `;
            }
            
            if (html) {
                predictionSection.innerHTML = html;
                predictionSection.style.display = 'block';
            }
        }

        // AIäºˆæƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆæ”¹å–„ç‰ˆï¼‰
        async function loadPredictions(races) {
            try {
                const response = await fetch('/api/races');
                const data = await response.json();
                
                if (data.success && data.races) {
                    // æ—¢å­˜ã®äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¤ã¤ã€æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°
                    const raceMap = new Map();
                    races.forEach(race => raceMap.set(race.race_id, race));
                    
                    data.races.forEach(fullRace => {
                        if (fullRace.prediction) {
                            // ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã«äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                            const existingRace = raceMap.get(fullRace.race_id);
                            if (existingRace) {
                                existingRace.prediction = fullRace.prediction;
                            }
                            updateRacePrediction(fullRace);
                        }
                    });
                    
                    // æ›´æ–°ã•ã‚ŒãŸãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å†ä¿å­˜
                    setCachedRaceData({
                        races: Array.from(raceMap.values()),
                        timestamp: Date.now(),
                        stats: {
                            total: races.length,
                            finished: races.filter(r => r.is_finished).length
                        }
                    });
                }
            } catch (error) {
                console.warn('äºˆæƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', error);
                // æ—¢å­˜ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è¡¨ç¤º
                displayCachedPredictions(races);
            }
        }

        // ãƒ¬ãƒ¼ã‚¹äºˆæƒ³æ›´æ–°
        function updateRacePrediction(race) {
            const predictionSection = document.getElementById(`prediction-${race.race_id}`);
            if (!predictionSection || !race.prediction) return;
            
            const prediction = race.prediction;
            const result = race.result;
            
            let html = '';
            
            // äºˆæƒ³ãƒ‡ãƒ¼ã‚¿
            if (prediction && prediction.predicted_win) {
                html += `
                    <div class="prediction-row">
                        <span>ğŸ† å˜å‹æ¨å¥¨:</span>
                        <span class="prediction-value">${prediction.predicted_win}å·è‰‡</span>
                    </div>
                `;
            }
            
            if (prediction && prediction.predicted_place && prediction.predicted_place.length > 0) {
                html += `
                    <div class="prediction-row">
                        <span>ğŸ¯ è¤‡å‹æ¨å¥¨:</span>
                        <span class="prediction-value">${prediction.predicted_place.join('-')}å·è‰‡</span>
                    </div>
                `;
            }
            
            if (prediction && prediction.confidence) {
                const confidencePercent = Math.round(prediction.confidence * 100);
                const stars = generateConfidenceStars(prediction.confidence);
                html += `
                    <div class="prediction-row">
                        <span>â­ äºˆæƒ³ç²¾åº¦:</span>
                        <span class="prediction-confidence">${stars} ${confidencePercent}%</span>
                    </div>
                `;
            }
            
            // çµæœãƒ‡ãƒ¼ã‚¿
            if (result) {
                html += `
                    <div class="prediction-row">
                        <span class="prediction-label">å®Ÿéš›:</span>
                        <div class="vs-display">
                            ${prediction ? `<span class="prediction-value">${prediction.predicted_win}å·è‰‡</span><span class="vs-arrow">â†’</span>` : ''}
                            <span class="result-value">
                                ${result.winning_boat}å·è‰‡
                                ${prediction ? `<span class="hit-indicator ${prediction.predicted_win == result.winning_boat ? 'hit' : 'miss'}">${prediction.predicted_win == result.winning_boat ? 'âœ“' : 'âœ—'}</span>` : ''}
                            </span>
                        </div>
                    </div>
                `;
                
                if (result.place_results && result.place_results.length > 0) {
                    html += `
                        <div class="prediction-row">
                            <span class="prediction-label">ç€é †:</span>
                            <span class="result-value">
                                ${result.place_results.slice(0, 3).join('-')}å·è‰‡
                            </span>
                        </div>
                    `;
                }
            }
            
            if (html) {
                predictionSection.innerHTML = html;
                predictionSection.style.display = 'block';
            }
        }

        // ä¿¡é ¼åº¦æ˜Ÿç”Ÿæˆ
        function generateConfidenceStars(confidence) {
            const totalStars = 5;
            const filledStars = Math.floor((confidence || 0.5) * totalStars);
            const emptyStars = totalStars - filledStars;
            
            return 'â˜…'.repeat(filledStars) + 'â˜†'.repeat(emptyStars);
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats(races) {
            const totalRaces = races.length;
            const confirmedTimes = races.filter(race => race.start_time !== 'æœªå®š').length;
            const venues = new Set(races.map(race => race.venue_name)).size;
            
            document.querySelector('.stats').innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${totalRaces}</div>
                    <div class="stat-label">æœ¬æ—¥é–‹å‚¬ãƒ¬ãƒ¼ã‚¹æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${confirmedTimes}</div>
                    <div class="stat-label">ç™ºèµ°æ™‚åˆ»ç¢ºå®š</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${venues}</div>
                    <div class="stat-label">é–‹å‚¬å ´æ•°</div>
                </div>
            `;
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorSection = document.getElementById('error-section');
            const errorText = document.getElementById('error-text');
            
            loadingIndicator.style.display = 'none';
            errorText.textContent = `âŒ ${message}`;
            errorSection.style.display = 'block';
        }

        // ãƒ›ãƒãƒ¼åŠ¹æœè¨­å®š
        function setupHoverEffects() {
            document.querySelectorAll('.race-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    const isDark = document.body.getAttribute('data-theme') === 'dark';
                    this.style.background = isDark ? 
                        'linear-gradient(135deg, #3d3d3d 0%, #4a4a4a 100%)' :
                        'linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.background = '';
                });
            });
        }

        // æ—¥ä»˜é¸æŠæ©Ÿèƒ½
        function getSelectedDate() {
            const dateInput = document.getElementById('date-select');
            // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è€ƒæ…®ã—ãŸä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
            const now = new Date();
            const today = now.getFullYear() + '-' + 
                         String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(now.getDate()).padStart(2, '0');
            const selectedValue = dateInput ? dateInput.value : null;
            
            console.log('ä»Šæ—¥ã®æ—¥ä»˜ (ä¿®æ­£ç‰ˆ):', today);
            console.log('é¸æŠã•ã‚ŒãŸæ—¥ä»˜:', selectedValue);
            console.log('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä½¿ç”¨åˆ¤å®š:', selectedValue !== today);
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã®å ´åˆã¯nullã€éå»ã®æ—¥ä»˜ã®å ´åˆã¯ãã®å€¤ã‚’è¿”ã™
            return selectedValue && selectedValue !== today ? selectedValue : null;
        }
        
        function changeDate(selectedDate) {
            // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è€ƒæ…®ã—ãŸä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
            const now = new Date();
            const today = now.getFullYear() + '-' + 
                         String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(now.getDate()).padStart(2, '0');
            if (selectedDate === today) {
                // ä»Šæ—¥ã®æ—¥ä»˜ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—ã§ãƒªãƒ­ãƒ¼ãƒ‰
                window.location.href = '/';
            } else {
                // éå»ã®æ—¥ä»˜ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€æ—¥ä»˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãã§ãƒªãƒ­ãƒ¼ãƒ‰
                window.location.href = `/?date=${selectedDate}`;
            }
        }

        // è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆ5åˆ†é–“éš”ï¼‰
        setTimeout(function() {
            location.reload();
        }, 300000);
    </script>
</body>
</html>